name: Bump Version

on:
  push:
    branches:
      - main

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: üèó Install Poetry
        uses: snok/install-poetry@v1
      - name: üèó Install ci dependencies
        run: poetry install --only=ci
      - name: Generate new version
        id: version
        run: echo version="$(poetry run python ci/bump_version.py)" >> $GITHUB_OUTPUT
      - name: ‚¨Ü Update fastapi __version__
        run: |
          echo '__version__ = "${{ fromJSON(steps.version.outputs.version).next_version }}"' \
          | tee ./arunapi/__init__.py
      - name: üèó Set up yq
        uses: frenck/action-setup-yq@v1
      - name: ‚¨Ü Update helm chart version
        run: |
          yq e -i '.appVersion = "${{ fromJSON(steps.version.outputs.version).next_version }}"' ./chart/Chart.yaml
          yq e -i '.version = "${{ fromJSON(steps.version.outputs.version).next_version }}"' ./chart/Chart.yaml
      - name: test files were updated
        run: |
          echo fastapi
          cat ./arunapi/__init__.py
          echo chart
          cat ./chart/Chart.yaml
